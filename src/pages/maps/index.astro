---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';

const maps = (await getCollection('maps')).sort(
  (a, b) => b.data.date.valueOf() - a.data.date.valueOf()
);
---

<BaseLayout title="Maps | Sambit">
  <header class="page-header">
    <h1>Maps</h1>
    <p class="lead">Cross-domain connections, pattern synthesis, conceptual mappings, and maps of content</p>
  </header>

  <!-- Notion-style Filters -->
  <div class="filters-bar">
    <div class="filter-group">
      <label class="filter-label">Type</label>
      <div class="select-wrapper" data-filter="mapType">
        <button class="filter-select" type="button">
          <span class="select-value">All</span>
          <svg class="select-icon" width="12" height="12" viewBox="0 0 12 12" fill="none">
            <path d="M2 4L6 8L10 4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
        <div class="select-dropdown" hidden>
          <button class="dropdown-item" data-value="">All Types</button>
          <button class="dropdown-item" data-value="moc">Map of Content</button>
          <button class="dropdown-item" data-value="synthesis">Synthesis</button>
          <button class="dropdown-item" data-value="literature">Literature Review</button>
          <button class="dropdown-item" data-value="conceptual">Conceptual</button>
        </div>
      </div>
    </div>

    <div class="filter-group">
      <label class="filter-label">Domain</label>
      <div class="select-wrapper" data-filter="domain">
        <button class="filter-select" type="button">
          <span class="select-value">All</span>
          <svg class="select-icon" width="12" height="12" viewBox="0 0 12 12" fill="none">
            <path d="M2 4L6 8L10 4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
        <div class="select-dropdown" hidden>
          <button class="dropdown-item" data-value="">All Domains</button>
          <button class="dropdown-item" data-value="cognitive-science">Cognitive Science</button>
          <button class="dropdown-item" data-value="cognitive-architecture">Cognitive Architecture</button>
          <button class="dropdown-item" data-value="complexity-science">Complexity Science</button>
          <button class="dropdown-item" data-value="systems-thinking">Systems Thinking</button>
          <button class="dropdown-item" data-value="epistemology">Epistemology</button>
        </div>
      </div>
    </div>

    <button class="clear-filters" type="button" hidden>
      <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
        <path d="M3.5 3.5L10.5 10.5M10.5 3.5L3.5 10.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
      </svg>
      Clear
    </button>
  </div>

  <div class="maps-gallery" data-gallery>
    {maps.map((map) => {
      const primaryType = map.data.visualType?.[0] || 'diagram';
      const mapType = map.data.mapType;
      return (
        <article class="gallery-item" data-map-type={mapType} data-domains={map.data.domains.join(',')}>
          <a href={`/maps/${map.id}`} class="gallery-link">
            <div class={`visual-preview ${primaryType}`}>
              <div class="preview-pattern"></div>
              <div class="maptype-label">
                <span class="maptype-badge">{mapType}</span>
              </div>
            </div>

            <div class="gallery-content">
              <div class="domains-row">
                {map.data.domains.map((domain) => (
                  <span
                    class="domain-badge"
                    data-domain={domain.toLowerCase().replace(/\s+/g, '-')}>
                    {domain}
                  </span>
                ))}
              </div>

              <h2>{map.data.title}</h2>
              <p class="description">{map.data.description}</p>

              {map.data.patterns && map.data.patterns.length > 0 && (
                <div class="patterns-footer">
                  {map.data.patterns.slice(0, 3).map((pattern) => (
                    <span class="pattern-tag">{pattern}</span>
                  ))}
                  {map.data.patterns.length > 3 && (
                    <span class="pattern-more">+{map.data.patterns.length - 3} more</span>
                  )}
                  {map.data.visualType && map.data.visualType.length > 0 && (
                    <span class="visual-type-label">
                      {map.data.visualType.join(', ')}
                    </span>
                  )}
                </div>
              )}
            </div>
          </a>
        </article>
      );
    })}
  </div>

  {maps.length === 0 && (
    <div class="empty-state">
      <p>No maps yet. Check back soon.</p>
    </div>
  )}
</BaseLayout>

<script>
  // Notion-style filter system
  let activeFilters = {
    mapType: '',
    domain: ''
  };

  // Initialize dropdowns
  document.querySelectorAll('.select-wrapper').forEach(wrapper => {
    const selectButton = wrapper.querySelector('.filter-select');
    const dropdown = wrapper.querySelector('.select-dropdown');
    const filterType = wrapper.getAttribute('data-filter');

    // Toggle dropdown
    selectButton?.addEventListener('click', (e) => {
      e.stopPropagation();
      const isOpen = !dropdown?.hasAttribute('hidden');

      // Close all other dropdowns
      document.querySelectorAll('.select-dropdown').forEach(d => d.setAttribute('hidden', ''));

      // Toggle this dropdown
      if (isOpen) {
        dropdown?.setAttribute('hidden', '');
      } else {
        dropdown?.removeAttribute('hidden');
      }
    });

    // Handle dropdown item clicks
    dropdown?.querySelectorAll('.dropdown-item').forEach(item => {
      item.addEventListener('click', (e) => {
        e.stopPropagation();
        const value = item.getAttribute('data-value') || '';
        const label = item.textContent?.trim() || 'All';

        // Update filter state
        if (filterType) {
          activeFilters[filterType] = value;
        }

        // Update button text
        const valueSpan = selectButton?.querySelector('.select-value');
        if (valueSpan) {
          valueSpan.textContent = value ? label : 'All';
        }

        // Close dropdown
        dropdown.setAttribute('hidden', '');

        // Apply filters
        applyFilters();
      });
    });
  });

  // Close dropdowns when clicking outside
  document.addEventListener('click', () => {
    document.querySelectorAll('.select-dropdown').forEach(d => d.setAttribute('hidden', ''));
  });

  // Clear filters button
  const clearButton = document.querySelector('.clear-filters');
  clearButton?.addEventListener('click', () => {
    activeFilters = { mapType: '', domain: '' };

    // Reset all select buttons
    document.querySelectorAll('.select-value').forEach(span => {
      span.textContent = 'All';
    });

    applyFilters();
  });

  function applyFilters() {
    const items = document.querySelectorAll('.gallery-item');
    let hasActiveFilters = activeFilters.mapType || activeFilters.domain;

    items.forEach(item => {
      const mapType = item.getAttribute('data-map-type');
      const domains = item.getAttribute('data-domains')?.split(',') || [];

      let show = true;

      if (activeFilters.mapType && mapType !== activeFilters.mapType) {
        show = false;
      }

      if (activeFilters.domain && !domains.includes(activeFilters.domain)) {
        show = false;
      }

      if (show) {
        item.style.display = '';
        item.style.opacity = '1';
      } else {
        item.style.display = 'none';
        item.style.opacity = '0';
      }
    });

    // Show/hide clear button
    if (hasActiveFilters) {
      clearButton?.removeAttribute('hidden');
    } else {
      clearButton?.setAttribute('hidden', '');
    }
  }
</script>

<style>
  .page-header {
    margin-bottom: 3rem;
  }

  .lead {
    font-size: 1.125rem;
    color: var(--text-secondary);
    margin-top: 0.5rem;
  }

  /* Notion-style Filters */
  .filters-bar {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 2rem;
    flex-wrap: wrap;
  }

  .filter-group {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .filter-label {
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--text-secondary);
  }

  .select-wrapper {
    position: relative;
  }

  .filter-select {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.375rem 0.75rem;
    font-size: 0.875rem;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 0.375rem;
    color: var(--text-primary);
    cursor: pointer;
    transition: all 0.15s ease;
    min-width: 140px;
  }

  .filter-select:hover {
    background: var(--surface-hover);
    border-color: var(--text-tertiary);
  }

  .select-value {
    flex: 1;
    text-align: left;
    font-weight: 400;
  }

  .select-icon {
    color: var(--text-tertiary);
    transition: transform 0.2s ease;
  }

  .filter-select:hover .select-icon {
    color: var(--text-secondary);
  }

  .select-dropdown {
    position: absolute;
    top: calc(100% + 0.25rem);
    left: 0;
    min-width: 180px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 0.5rem;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    padding: 0.25rem;
    z-index: 100;
  }

  [data-theme="dark"] .select-dropdown {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
  }

  .dropdown-item {
    display: block;
    width: 100%;
    text-align: left;
    padding: 0.5rem 0.75rem;
    font-size: 0.875rem;
    background: transparent;
    border: none;
    border-radius: 0.25rem;
    color: var(--text-primary);
    cursor: pointer;
    transition: background 0.15s ease;
  }

  .dropdown-item:hover {
    background: var(--surface-hover);
  }

  .clear-filters {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.375rem 0.75rem;
    font-size: 0.875rem;
    background: transparent;
    border: 1px solid var(--border);
    border-radius: 0.375rem;
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.15s ease;
    margin-left: auto;
  }

  .clear-filters:hover {
    background: var(--surface-hover);
    color: var(--text-primary);
    border-color: var(--text-tertiary);
  }

  .clear-filters svg {
    width: 14px;
    height: 14px;
  }

  .maps-gallery {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(420px, 1fr));
    gap: 2rem;
  }

  .gallery-item {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 0.75rem;
    overflow: hidden;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                opacity 0.4s ease,
                transform 0.3s ease;
  }

  .gallery-item:hover {
    border-color: var(--accent);
    box-shadow: var(--shadow-lg);
    transform: translateY(-6px);
  }

  .gallery-link {
    text-decoration: none;
    color: inherit;
    display: block;
  }

  /* Visual Preview Area */
  .visual-preview {
    position: relative;
    height: 200px;
    overflow: hidden;
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
  }

  [data-theme="dark"] .visual-preview {
    background: linear-gradient(135deg, #0c4a6e 0%, #075985 100%);
  }

  .visual-preview.diagram {
    background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
  }

  [data-theme="dark"] .visual-preview.diagram {
    background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
  }

  .visual-preview.animation {
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
  }

  [data-theme="dark"] .visual-preview.animation {
    background: linear-gradient(135deg, #78350f 0%, #92400e 100%);
  }

  .visual-preview.data-viz {
    background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
  }

  [data-theme="dark"] .visual-preview.data-viz {
    background: linear-gradient(135deg, #14532d 0%, #166534 100%);
  }

  .visual-preview.interactive {
    background: linear-gradient(135deg, #fdf4ff 0%, #fae8ff 100%);
  }

  [data-theme="dark"] .visual-preview.interactive {
    background: linear-gradient(135deg, #581c87 0%, #6b21a8 100%);
  }

  /* Preview Patterns - Abstract Visual Representations */
  .preview-pattern {
    position: absolute;
    inset: 0;
    opacity: 0.15;
  }

  .diagram .preview-pattern {
    background-image:
      linear-gradient(0deg, transparent 24%, rgba(59, 130, 246, 0.3) 25%, rgba(59, 130, 246, 0.3) 26%, transparent 27%, transparent 74%, rgba(59, 130, 246, 0.3) 75%, rgba(59, 130, 246, 0.3) 76%, transparent 77%, transparent),
      linear-gradient(90deg, transparent 24%, rgba(59, 130, 246, 0.3) 25%, rgba(59, 130, 246, 0.3) 26%, transparent 27%, transparent 74%, rgba(59, 130, 246, 0.3) 75%, rgba(59, 130, 246, 0.3) 76%, transparent 77%, transparent);
    background-size: 50px 50px;
  }

  .animation .preview-pattern {
    background: repeating-linear-gradient(
      45deg,
      transparent,
      transparent 20px,
      rgba(251, 191, 36, 0.3) 20px,
      rgba(251, 191, 36, 0.3) 22px
    );
  }

  .data-viz .preview-pattern {
    background-image: linear-gradient(90deg, transparent 79px, rgba(34, 197, 94, 0.3) 79px, rgba(34, 197, 94, 0.3) 81px, transparent 81px),
      linear-gradient(rgba(34, 197, 94, 0.2) 0.5px, transparent 0.5px);
    background-size: 80px 20px;
  }

  .interactive .preview-pattern {
    background-image: radial-gradient(circle, rgba(168, 85, 247, 0.3) 1px, transparent 1px);
    background-size: 30px 30px;
  }

  .maptype-label {
    position: absolute;
    top: 1rem;
    right: 1rem;
    display: flex;
    gap: 0.5rem;
  }

  .maptype-badge {
    font-size: 0.6875rem;
    padding: 0.25rem 0.625rem;
    background: rgba(0, 0, 0, 0.75);
    color: white;
    border-radius: 0.25rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.075em;
    border: 1.5px solid rgba(255, 255, 255, 0.25);
    backdrop-filter: blur(8px);
    display: inline-block;
  }

  [data-theme="dark"] .maptype-badge {
    background: rgba(255, 255, 255, 0.15);
    color: white;
    border: 1.5px solid rgba(255, 255, 255, 0.35);
    backdrop-filter: blur(8px);
  }

  /* Gallery Content */
  .gallery-content {
    padding: 1.5rem;
  }

  .domains-row {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 1rem;
  }

  /* Swiss Design: High Contrast Minimal with Semantic Color */
  .domain-badge {
    font-size: 0.6875rem;
    padding: 0.25rem 0.75rem;
    background: rgba(0, 0, 0, 0.05);
    color: var(--text-primary);
    border: 1.5px solid rgba(0, 0, 0, 0.15);
    border-radius: 0.25rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.075em;
    display: inline-block;
  }

  /* Cognitive/Mind - Blue */
  .domain-badge[data-domain*="cognitive"],
  .domain-badge[data-domain*="mind"] {
    background: rgba(59, 130, 246, 0.08);
    border-color: rgba(59, 130, 246, 0.25);
    color: #1e40af;
  }

  /* Complexity/Systems - Purple */
  .domain-badge[data-domain*="complexity"],
  .domain-badge[data-domain*="systems"] {
    background: rgba(139, 92, 246, 0.08);
    border-color: rgba(139, 92, 246, 0.25);
    color: #6b21a8;
  }

  /* Epistemology/Philosophy - Rose */
  .domain-badge[data-domain*="epistemology"],
  .domain-badge[data-domain*="philosophy"] {
    background: rgba(236, 72, 153, 0.08);
    border-color: rgba(236, 72, 153, 0.25);
    color: #9f1239;
  }

  /* Architecture/Design - Green */
  .domain-badge[data-domain*="architecture"],
  .domain-badge[data-domain*="design"] {
    background: rgba(34, 197, 94, 0.08);
    border-color: rgba(34, 197, 94, 0.25);
    color: #15803d;
  }

  /* Method/Methodology - Amber */
  .domain-badge[data-domain*="method"] {
    background: rgba(245, 158, 11, 0.08);
    border-color: rgba(245, 158, 11, 0.25);
    color: #92400e;
  }

  [data-theme="dark"] .domain-badge {
    background: rgba(255, 255, 255, 0.05);
    border-color: rgba(255, 255, 255, 0.2);
    color: var(--text-secondary);
  }

  /* Dark mode semantic colors - desaturated */
  [data-theme="dark"] .domain-badge[data-domain*="cognitive"],
  [data-theme="dark"] .domain-badge[data-domain*="mind"] {
    background: rgba(59, 130, 246, 0.1);
    border-color: rgba(59, 130, 246, 0.25);
    color: #93c5fd;
  }

  [data-theme="dark"] .domain-badge[data-domain*="complexity"],
  [data-theme="dark"] .domain-badge[data-domain*="systems"] {
    background: rgba(139, 92, 246, 0.1);
    border-color: rgba(139, 92, 246, 0.25);
    color: #c4b5fd;
  }

  [data-theme="dark"] .domain-badge[data-domain*="epistemology"],
  [data-theme="dark"] .domain-badge[data-domain*="philosophy"] {
    background: rgba(236, 72, 153, 0.1);
    border-color: rgba(236, 72, 153, 0.25);
    color: #f9a8d4;
  }

  [data-theme="dark"] .domain-badge[data-domain*="architecture"],
  [data-theme="dark"] .domain-badge[data-domain*="design"] {
    background: rgba(34, 197, 94, 0.1);
    border-color: rgba(34, 197, 94, 0.25);
    color: #86efac;
  }

  [data-theme="dark"] .domain-badge[data-domain*="method"] {
    background: rgba(245, 158, 11, 0.1);
    border-color: rgba(245, 158, 11, 0.25);
    color: #fcd34d;
  }

  .gallery-item h2 {
    font-size: 1.25rem;
    font-weight: 600;
    margin: 0 0 0.625rem 0;
    line-height: 1.3;
    color: var(--text-primary);
    font-family: var(--font-serif);
  }

  .description {
    color: var(--text-secondary);
    font-size: 0.9375rem;
    line-height: 1.6;
    margin: 0 0 1rem 0;
  }

  .patterns-footer {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    padding-top: 0.75rem;
    border-top: 1px solid var(--border);
  }

  .pattern-tag {
    font-size: 0.75rem;
    padding: 0.25rem 0.625rem;
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text-secondary);
    border-radius: 0.25rem;
    font-style: italic;
    font-weight: 400;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .pattern-tag:hover {
    background: var(--surface);
    border-color: var(--text-tertiary);
  }

  [data-theme="dark"] .pattern-tag {
    border-color: rgba(255, 255, 255, 0.15);
    color: var(--text-secondary);
  }

  [data-theme="dark"] .pattern-tag:hover {
    background: rgba(255, 255, 255, 0.03);
    border-color: rgba(255, 255, 255, 0.25);
  }

  .pattern-more {
    font-size: 0.75rem;
    color: var(--text-tertiary);
    padding: 0.25rem 0.5rem;
  }

  .visual-type-label {
    font-size: 0.6875rem;
    padding: 0.25rem 0.625rem;
    background: transparent;
    border: 1px dashed var(--border);
    color: var(--text-tertiary);
    border-radius: 0.25rem;
    font-weight: 400;
    font-style: italic;
    text-transform: lowercase;
  }

  [data-theme="dark"] .visual-type-label {
    border-color: rgba(255, 255, 255, 0.2);
    color: var(--text-tertiary);
  }

  .empty-state {
    text-align: center;
    padding: 4rem 2rem;
    color: var(--text-secondary);
  }

  @media (max-width: 768px) {
    .maps-gallery {
      grid-template-columns: 1fr;
    }

    .visual-preview {
      height: 180px;
    }
  }
</style>
